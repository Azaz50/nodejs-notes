<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
</head>
<body class="p-4">

  <div class="container">
    <h2 class="mb-4">Student Records</h2>

    <div class="d-flex justify-content-between mb-3">
      <div class="input-group w-50">
        <span class="input-group-text">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16"><path d="M480 272C480 317.9 465.1 360.3 440 394.7L566.6 521.4C579.1 533.9 579.1 554.2 566.6 566.7C554.1 579.2 533.8 579.2 521.3 566.7L394.7 440C360.3 465.1 317.9 480 272 480C157.1 480 64 386.9 64 272C64 157.1 157.1 64 272 64C386.9 64 480 157.1 480 272zM272 416C351.5 416 416 351.5 416 272C416 192.5 351.5 128 272 128C192.5 128 128 192.5 128 272C128 351.5 192.5 416 272 416z"/></svg>
        </span>
        <input type="text" id="searchInput" class="form-control" placeholder="Search by name">
      </div>
      <div class="d-flex align-items-center gap-3">
        <div data-bs-toggle="modal" data-bs-target="#addStudentModal">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="30" height="30"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#22d61f" d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM296 408L296 344L232 344C218.7 344 208 333.3 208 320C208 306.7 218.7 296 232 296L296 296L296 232C296 218.7 306.7 208 320 208C333.3 208 344 218.7 344 232L344 296L408 296C421.3 296 432 306.7 432 320C432 333.3 421.3 344 408 344L344 344L344 408C344 421.3 333.3 432 320 432C306.7 432 296 421.3 296 408z"/></svg>
        </div>
        <div onclick="fetchStudents()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="30" height="30"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#74C0FC" d="M129.9 292.5C143.2 199.5 223.3 128 320 128C373 128 421 149.5 455.8 184.2C456 184.4 456.2 184.6 456.4 184.8L464 192L416.1 192C398.4 192 384.1 206.3 384.1 224C384.1 241.7 398.4 256 416.1 256L544.1 256C561.8 256 576.1 241.7 576.1 224L576.1 96C576.1 78.3 561.8 64 544.1 64C526.4 64 512.1 78.3 512.1 96L512.1 149.4L500.8 138.7C454.5 92.6 390.5 64 320 64C191 64 84.3 159.4 66.6 283.5C64.1 301 76.2 317.2 93.7 319.7C111.2 322.2 127.4 310 129.9 292.6zM573.4 356.5C575.9 339 563.7 322.8 546.3 320.3C528.9 317.8 512.6 330 510.1 347.4C496.8 440.4 416.7 511.9 320 511.9C267 511.9 219 490.4 184.2 455.7C184 455.5 183.8 455.3 183.6 455.1L176 447.9L223.9 447.9C241.6 447.9 255.9 433.6 255.9 415.9C255.9 398.2 241.6 383.9 223.9 383.9L96 384C87.5 384 79.3 387.4 73.3 393.5C67.3 399.6 63.9 407.7 64 416.3L65 543.3C65.1 561 79.6 575.2 97.3 575C115 574.8 129.2 560.4 129 542.7L128.6 491.2L139.3 501.3C185.6 547.4 249.5 576 320 576C449 576 555.7 480.6 573.4 356.5z"/></svg>
        </div>
        <div onclick="logout()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="30" height="30">!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.<path fill="#e13214" d="M224 160C241.7 160 256 145.7 256 128C256 110.3 241.7 96 224 96L160 96C107 96 64 139 64 192L64 448C64 501 107 544 160 544L224 544C241.7 544 256 529.7 256 512C256 494.3 241.7 480 224 480L160 480C142.3 480 128 465.7 128 448L128 192C128 174.3 142.3 160 160 160L224 160zM566.6 342.6C579.1 330.1 579.1 309.8 566.6 297.3L438.6 169.3C426.1 156.8 405.8 156.8 393.3 169.3C380.8 181.8 380.8 202.1 393.3 214.6L466.7 288L256 288C238.3 288 224 302.3 224 320C224 337.7 238.3 352 256 352L466.7 352L393.3 425.4C380.8 437.9 380.8 458.2 393.3 470.7C405.8 483.2 426.1 483.2 438.6 470.7L566.6 342.7z"/></svg>
        </div>
      </div>
    </div>

    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Profile</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Gender</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="studentTableBody"></tbody>
    </table>

    <nav>
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
  </div>

  <!-- View Student Modal -->
<div class="modal fade" id="viewStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Student Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <img id="viewProfilePic" src="" class="rounded mb-3" width="100" />
        <p><strong>Name:</strong> <span id="viewName"></span></p>
        <p><strong>Email:</strong> <span id="viewEmail"></span></p>
        <p><strong>Phone:</strong> <span id="viewPhone"></span></p>
        <p><strong>Gender:</strong> <span id="viewGender"></span></p>
      </div>
    </div>
  </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addStudentForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Add New Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <input type="text" class="form-control" name="first_name" placeholder="First Name" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" name="last_name" placeholder="Last Name" required>
          </div>
          <div class="mb-2">
            <input type="email" class="form-control" name="email" placeholder="Email" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" name="phone" placeholder="Phone" required>
          </div>
          <div class="mb-2">
            <select class="form-select" name="gender" required>
              <option value="">Select Gender</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div class="mb-2">
            <label>Upload Profile Picture:</label>
            <input type="file" class="form-control" name="profile_pic" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Create Student</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editStudentForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Edit Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editStudentId">
          <div class="mb-2">
            <input type="text" class="form-control" id="editFirstName" name="first_name" placeholder="First Name" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" id="editLastName" name="last_name" placeholder="Last Name" required>
          </div>
          <div class="mb-2">
            <input type="email" class="form-control" id="editEmail" name="email" placeholder="Email" required>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" id="editPhone" name="phone" placeholder="Phone" required>
          </div>
          <div class="mb-2">
            <select class="form-select" id="editGender" name="gender" required>
              <option value="">Select Gender</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div class="mb-2">
            <label>Upload New Profile Picture:</label>
            <input type="file" class="form-control" id="editProfilePic" name="profile_pic">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
<script>
  // REPLACE 'http://localhost:3000' WITH YOUR VERCEL BACKEND URL AFTER DEPLOYING BACKEND
  const BASE_URL = 'http://localhost:3000'; 
  const apiUrl = `${BASE_URL}/api/students`;
  let currentPage = 1
  let currentSearch = ''

  function checkAuth() {
    const token = localStorage.getItem("token")
    if(!token){
      alert("You must be logged in to view this page")
      window.location.href = "index.html"
    }
    return token
  }

  const token = checkAuth()

  // View All Students
  async function fetchStudents(search = '', page = 1){
    currentPage = page
    currentSearch = search

    const res = await fetch(
      `${apiUrl}?search=${encodeURIComponent(search)}&page=${page}&limit=3`,
      {
        headers: {
          "Authorization": `Bearer ${token}`,
        },
      }
    )
    const data = await res.json()
    // console.log(data)
    
    const tbody = document.querySelector('#studentTableBody')
    tbody.innerHTML = ''

    data.students.forEach(student => {
      tbody.innerHTML += `
        <tr>
          <td><img src="${BASE_URL}/uploads/${student.profile_pic}" width="50" height="50" class="rounded-circle" /></td>
          <td>${student.first_name}</td>
          <td>${student.last_name}</td>
          <td>${student.email}</td>
          <td>${student.phone}</td>
          <td>${student.gender}</td>
          <td>
            <div class="d-flex gap-3">
              <div onclick="viewStudent('${student._id}')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="25" height="25"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#74C0FC" d="M73 39.1C63.6 29.7 48.4 29.7 39.1 39.1C29.8 48.5 29.7 63.7 39 73.1L567 601.1C576.4 610.5 591.6 610.5 600.9 601.1C610.2 591.7 610.3 576.5 600.9 567.2L504.5 470.8C507.2 468.4 509.9 466 512.5 463.6C559.3 420.1 590.6 368.2 605.5 332.5C608.8 324.6 608.8 315.8 605.5 307.9C590.6 272.2 559.3 220.2 512.5 176.8C465.4 133.1 400.7 96.2 319.9 96.2C263.1 96.2 214.3 114.4 173.9 140.4L73 39.1zM208.9 175.1C241 156.2 278.1 144 320 144C385.2 144 438.8 173.6 479.9 211.7C518.4 247.4 545 290 558.5 320C544.9 350 518.3 392.5 479.9 428.3C476.8 431.1 473.7 433.9 470.5 436.7L425.8 392C439.8 371.5 448 346.7 448 320C448 249.3 390.7 192 320 192C293.3 192 268.5 200.2 248 214.2L208.9 175.1zM390.9 357.1L282.9 249.1C294 243.3 306.6 240 320 240C364.2 240 400 275.8 400 320C400 333.4 396.7 346 390.9 357.1zM135.4 237.2L101.4 203.2C68.8 240 46.4 279 34.5 307.7C31.2 315.6 31.2 324.4 34.5 332.3C49.4 368 80.7 420 127.5 463.4C174.6 507.1 239.3 544 320.1 544C357.4 544 391.3 536.1 421.6 523.4L384.2 486C364.2 492.4 342.8 496 320 496C254.8 496 201.2 466.4 160.1 428.3C121.6 392.6 95 350 81.5 320C91.9 296.9 110.1 266.4 135.5 237.2z"/></svg>
              </div>
              <div onclick="editStudent('${student._id}')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="25" height="25"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#FFD43B" d="M505 122.9L517.1 135C526.5 144.4 526.5 159.6 517.1 168.9L488 198.1L441.9 152L471 122.9C480.4 113.5 495.6 113.5 504.9 122.9zM273.8 320.2L408 185.9L454.1 232L319.8 366.2C316.9 369.1 313.3 371.2 309.4 372.3L250.9 389L267.6 330.5C268.7 326.6 270.8 323 273.7 320.1zM437.1 89L239.8 286.2C231.1 294.9 224.8 305.6 221.5 317.3L192.9 417.3C190.5 425.7 192.8 434.7 199 440.9C205.2 447.1 214.2 449.4 222.6 447L322.6 418.4C334.4 415 345.1 408.7 353.7 400.1L551 202.9C579.1 174.8 579.1 129.2 551 101.1L538.9 89C510.8 60.9 465.2 60.9 437.1 89zM152 128C103.4 128 64 167.4 64 216L64 488C64 536.6 103.4 576 152 576L424 576C472.6 576 512 536.6 512 488L512 376C512 362.7 501.3 352 488 352C474.7 352 464 362.7 464 376L464 488C464 510.1 446.1 528 424 528L152 528C129.9 528 112 510.1 112 488L112 216C112 193.9 129.9 176 152 176L264 176C277.3 176 288 165.3 288 152C288 138.7 277.3 128 264 128L152 128z"/></svg>
              </div>
              <div onclick="deleteStudent('${student._id}')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="25" height="25"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#f63404" d="M262.2 48C248.9 48 236.9 56.3 232.2 68.8L216 112L120 112C106.7 112 96 122.7 96 136C96 149.3 106.7 160 120 160L520 160C533.3 160 544 149.3 544 136C544 122.7 533.3 112 520 112L424 112L407.8 68.8C403.1 56.3 391.2 48 377.8 48L262.2 48zM128 208L128 512C128 547.3 156.7 576 192 576L448 576C483.3 576 512 547.3 512 512L512 208L464 208L464 512C464 520.8 456.8 528 448 528L192 528C183.2 528 176 520.8 176 512L176 208L128 208zM288 280C288 266.7 277.3 256 264 256C250.7 256 240 266.7 240 280L240 456C240 469.3 250.7 480 264 480C277.3 480 288 469.3 288 456L288 280zM400 280C400 266.7 389.3 256 376 256C362.7 256 352 266.7 352 280L352 456C352 469.3 362.7 480 376 480C389.3 480 400 469.3 400 456L400 280z"/></svg>
              </div>
            </div>
          </td>
        </tr>
      `
    });

    renderPagination(data.totalPage)
  }

  fetchStudents() // Call fetchStudents() when page load first time

  // Pagination Function
  function renderPagination(totalPages){
    const container = document.querySelector("#pagination")
    container.innerHTML = ''

    // Previous Button
    const prevli = document.createElement('li')
    prevli.className = 'page-item' + (currentPage === 1 ? ' disabled' : '')
    prevli.innerHTML = `<a class="page-link" href="#">Previous</a>`
    prevli.addEventListener("click", (e)=>{
        e.preventDefault()
        fetchStudents(currentSearch, currentPage - 1)
      })
      container.appendChild(prevli)

      // Numbered Pagination
    for(let i = 1; i <= totalPages; i++){
      const li = document.createElement('li')
      li.className = 'page-item' + (i === currentPage ? ' active' : '')
      li.innerHTML = `<a class="page-link" href="#">${i}</a>`
      li.addEventListener("click", (e)=>{
        e.preventDefault()
        fetchStudents(currentSearch, i)
      })
      container.appendChild(li)
    }

    // Next Button
    const nextli = document.createElement('li')
    nextli.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '')
    nextli.innerHTML = `<a class="page-link" href="#">Next</a>`
    nextli.addEventListener("click", (e)=>{
        e.preventDefault()
        fetchStudents(currentSearch, currentPage + 1)
      })
      container.appendChild(nextli)
  }

  // View Single Student Record
  async function viewStudent(id) {
    const res = await fetch(
      `${apiUrl}/${id}`,
      {
        headers: {
          "Authorization": `Bearer ${token}`,
        },
      }
    )
    const student = await res.json()
    // console.log(data)

    document.querySelector("#viewProfilePic").src = `${BASE_URL}/uploads/${student.profile_pic}`
    document.querySelector("#viewName").textContent = `${student.first_name} ${student.last_name}`
    document.querySelector("#viewEmail").textContent = student.email
    document.querySelector("#viewPhone").textContent = student.phone
    document.querySelector("#viewGender").textContent = student.gender

    new bootstrap.Modal(document.querySelector("#viewStudentModal")).show()
  }

  // Search Student
  document.querySelector("#searchInput").addEventListener("input", () => {
    currentPage = 1
    fetchStudents(document.querySelector("#searchInput").value, currentPage)
  })

  // Add New Student 
  document.querySelector("#addStudentForm").addEventListener("submit",async function(e){
    e.preventDefault()

    const formData = new FormData(this)

    const res = await fetch(apiUrl, {
      method: 'POST',
      body: formData,
      headers: {
          "Authorization": `Bearer ${token}`,
      }
    })

    if(res.ok){
      this.reset()
      bootstrap.Modal.getInstance(document.querySelector("#addStudentModal")).hide()
      fetchStudents()
    }else{
      alert('Error creating student.')
    }
  })

  // Delete Student
  async function deleteStudent(id){
    if(confirm("Are you sure to delete this student ?")){
      await fetch(
        `${apiUrl}/${id}`,
        {
          method: 'DELETE',
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        }
      )
      fetchStudents()
    }
  }

  // Update Student Modal Box
  async function editStudent(id){
   
    const res = await fetch(
      `${apiUrl}/${id}`,
      {
        headers: {
          "Authorization": `Bearer ${token}`,
        },
      }
    )
    const student = await res.json()
   
    document.querySelector('#editStudentId').value = student._id
    document.querySelector('#editFirstName').value = student.first_name
    document.querySelector('#editLastName').value = student.last_name
    document.querySelector('#editEmail').value = student.email
    document.querySelector('#editPhone').value = student.phone
    document.querySelector('#editGender').value = student.gender

    new bootstrap.Modal(document.querySelector("#editStudentModal")).show()
  }

  // Update Student Record
  document.querySelector("#editStudentForm").addEventListener("submit",async function(e){
    e.preventDefault()

    const id = document.querySelector("#editStudentId").value
    
    const formData = new FormData(this)

    const res = await fetch(
      `${apiUrl}/${id}`,
      {
        method: 'PUT',
        body: formData,
        headers: {
          "Authorization": `Bearer ${token}`,
        },
      }
    )

    if(res.ok){
      bootstrap.Modal.getInstance(document.querySelector("#editStudentModal")).hide()
      fetchStudents()
    }else{
      alert('Error updating student.')
    }
  })

  
  // Logout Function
  function logout() {
    localStorage.removeItem("token")
    window.location.href = "index.html"
  }
</script>
</body>
</html>
